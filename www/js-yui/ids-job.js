var IDS_JOB;IdsJob=function(){var J="未知类型";var g="未知状态";var c=[];var F=[];var q=[];var I=0;var j=1;var f=[[[1,1],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],[[1,1],[2,1],[1,0],[1,0],[1,0],[1,0],[1,0]],[[1,0],[1,0],[3,1],[1,0],[1,0],[1,0],[1,0]],[[3,0],[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],[[1,1],[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],[[3,0],[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],[[4,0],[4,0],[4,0],[4,1],[5,1],[4,0],[4,0]],[[4,0],[4,0],[4,0],[4,0],[4,0],[5,1],[4,0]],[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]],[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]],[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]]];for(var H=0;H<5;H++){c[H]=$("#job_p"+(H+1))}function A(O){for(var N=0;N<c.length;N++){if(N==O-1){c[N].show()}else{c[N].hide()}}}function y(X,R,Z,S){var P,V,N,W,U,T;var O=function(aa){if(!aa){return""}var i=aa.lastIndexOf("\\");return i<0?aa:aa.substr(i+1)};var Q=function(i){var aa=i.data[0];var ab=IDS_CONTEXT_PATH+"/download?id="+aa.id;window.open(ab)};var Y=function(i){var ac=i.data[0];var ab=i.data[1];var aa=$.toJSON({id:ac.id});$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/attach/delete",data:aa,dataType:"json",success:function(){ab.remove()},error:function(){ajaxError(arguments,this)}})};if(!R){return}for(P=0;P<R.length;P++){V=R[P];N=O(V.filename);W=$(document.createElement("div"));W.addClass("att");if(Z){U=$(document.createElement("a"));U.addClass("att");U.addClass("ellipsis");U.click([V],Q);U.attr("title",N+"("+V.size+" bytes)")}else{U=$(document.createElement("span"));U.addClass("att");U.addClass("ellipsis")}U.text(N);W.append(U);if(S){T=$(document.createElement("a"));T.text("删除");T.addClass("del");T.click([V,W],Y);W.append(T)}X.append(W)}}function k(S){var i=$.browser;try{if(S.files[0]){return S.files[0].fileSize}else{if(i.msie&&i.version>=5&&i.version<=6){var N=new Image();N.src=S.value;return N.fileSize}else{S.select();var R=document.selection.createRange().text;var P=new ActiveXObject("Scripting.FileSystemObject");var O=P.GetFile(R);return O.fileSize}}}catch(Q){}return -1}function G(Y){var ac=Y.qobj;var S=Y.obj;var aa=Y.cat;var R=Y.uploadable;var Z=Y.qatts;var U=Y.atts;var ab=true;var T=R;var Q=Y.params;var i="#onAttUpload";var N=S.id;var W,X;var O="系统禁止上传后缀为{EXT}的文件!";var P="文件[{FILE}]的大小超过了20MB";Z.children().remove();y(Z,U,ab,T);try{if(ac[0].tagName!="A"){return}if(R){ac.text("添加附件");ac.addClass("enabled");new AjaxUpload(ac,{action:IDS_CONTEXT_PATH+"/upload",data:{cat:aa,owner:N,idx:0},onSubmit:function(ae,af){if(af&&/^(exe)$/.test(af)){MessageBox(O.replace("{EXT}",af),null,MB_ICONERROR,MB_OK,null,0);return false}var ad=k(this._input);if(ad>20*1024*1024){MessageBox(P.replace("{FILE}",ae),null,MB_ICONERROR,MB_OK,null,0);return false}},onComplete:function(ae,ad){W=$.evalJSON(ad);if(!W.success){if(W.error=="size.limit.exceeded"){X=P.replace("{FILE}",ae)}else{X=W.error}MessageBox("上传文件失败:\n"+X,null,MB_ICONERROR,MB_OK,null,0)}else{y(Z,W.atts,ab,T);if(typeof(Q[i])=="function"){Q[i](S,aa,ae,W,Q)}}}})}else{ac.text("附件");ac.addClass("disabled")}}catch(V){}}var M={"#type":function(){var O=IDS_ACC.pernr;var N=F[0];var i=this.act;if(i&&(i.approver1==O||i.approver2==O)){N=F[3]}else{if(i&&i.actor==O){N=F[2]}else{if(i&&i.actors&&i.actors.indexOf(O)>=0){N=F[2]}else{if(this.approver1==O||this.approver2==O){N=F[3]}else{if(this.requester==O){N=F[1]}}}}}return N?N.text:J},"#status":function(){var N=q[0];var i=this.act;if(this.status=="PASS2"&&i){if(i.status=="PASS2"){N=q[4]}else{if(i.status=="REJ1"||i.status=="REJ2"){N=q[5]}else{if(i.status=="PASS1"){N=q[3]}else{if(i.status=="NEW"){N=q[2]}}}}}else{if(this.status=="REJ1"||this.status=="REJ2"){N=q[5]}else{if(this.status=="NEW"||this.status=="PASS1"){N=q[1]}}}return N?N.text:g},"#step":function(){var i=[0,0];var Y=0,S=0,T=0;var Z=this.status;var V=this.act;var N=V?V.status:null;if(Z==null){Y=0}else{if(Z=="NEW"){Y=1}else{if(Z=="PASS1"){Y=2}else{if(Z=="REJ1"){Y=3}else{if(Z=="REJ2"){Y=4}else{if(Z=="DELETE"){Y=5}else{if(Z=="PASS2"){if(V==null||N=="NEW"){Y=6}else{if(N=="PASS1"){Y=7}else{if(N=="REJ1"){Y=8}else{if(N=="PASS2"){Y=9}else{if(N=="REJ2"){Y=10}}}}}}}}}}}}var X=this.requester;var Q=this.approver1;var O=this.approver2;var U=V?V.actor:null;var R=V?V.approver1:null;var P=V?V.approver2:null;var W=IDS_ACC.pernr;if(W==P){S=5}else{if(W==R){S=4}else{if(W==U){S=3}else{if(W==O){S=2}else{if(W==Q){S=1}else{if(W==X){S=0}else{S=6}}}}}}if(Y>=0&&Y<f.length&&S>=0&&S<f[Y].length){i=f[Y][S]}return{page:i[0],op:i[1]}},"#check":false,"#checkItems":[],"#changed":function(){var N=false;var i=this["#checkItems"];if(!i||i.length<=0||!this["#check"]){return N}i.each(function(){var O=$(this).attr("_value");if(typeof(O)=="undefined"){O=""}if(O!=$(this).val()){N=true}});return N},"#unload":function(){if(this["#changed"]()){return"您的提案还没有保存, 您确定离开吗?"}},"#onJobReturn":null,"#onJobAdd":null,"#onJobSave":null,"#onJobDelete":null,"#onJobPass1":null,"#onJobRej1":null,"#onJobPass2":null,"#onJobRej2":null,"#onAttUpload":null};this.setTypes=function(i){F=i};this.setStatus=function(i){q=i};this.initJob=function(i){$.extend(i,M);i["#typeText"]=i["#type"]();i["#statusText"]=i["#status"]()};this.openJob=function(Q,R){var P=Q.job;$.extend(P,M);var O=P["#step"]();var N;A(O.page);var i=[x,v,u,t,s,r];if(O.page>=0&&O.page<i.length&&typeof(i[O.page])=="function"){N=i[O.page](P,O.op,Q,R);if(typeof(N)!="undefined"&&!N){return}}P["#check"]=typeof(R.check)=="undefined"?true:R.check;document.body.onbeforeunload=function(){return P["#unload"]()};return P};function n(Q,R,T){var P,O,N;var S=$("#job_buttons");S.children().remove();if(typeof(Q)!="undefined"&&Q.length>0){for(P=Q.length-1;P>=0;P--){O=Q[P];N=$(document.createElement("a"));N.addClass("button");N.text(O.text);if(typeof(O.click)=="function"){N.addClass("enabled");N.click([R,T,O],b)}else{N.addClass("disabled")}S.append(N)}S.show()}else{S.hide()}}function b(N){var O=N.data[0];var P=N.data[1];var i=N.data[2];if(typeof(i.click)=="function"){i.click(O,P)}}function x(N,P,i,O){MessageBox("系统错误: 未找到对应页面!",IDS_TITLE,MB_ICONERROR,MB_OK,null,6);return false}function v(P,S,O,R){var N;if(P.status=="NEW"){if(S==j){N=[{text:"修改",click:z},{text:"删除",click:E},{text:"返回",click:L}]}else{N=[{text:"修改"},{text:"删除"},{text:"返回",click:L}]}}else{N=[{text:"提交",click:K},{text:"返回",click:L}]}n(N,P,R);$("#p1_cat").children().remove();$("#p1_area").children().remove();$("#p1_team").children().remove();$("#p1_fsFlag").children().remove();$("#p1_cat").addOptions(O["job.cats"],{value:"code",text:"text"});$("#p1_area").addOptions(O["job.areas"],{value:"code",text:"text"});$("#p1_team").addOptions(O["job.teams"],{value:"code",text:"name"});$("#p1_fsFlag").addOptions(O["job.fsFlags"],{svalue:"N"});$("#p1_team").bind("change",B);B();if(P.cat){$("#p1_cat").val(P.cat)}if(P.area){$("#p1_area").val(P.area)}if(P.fsFlag){$("#p1_fsFlag").val(P.fsFlag)}$("#p1_title").val(P.title?P.title:"");$("#p1_content").val(P.content?P.content:"");$("#p1_fsValue").val(P.fsValue?P.fsValue:"");$("#p1_fsFormula").val(P.fsFormula?P.fsFormula:"");var i=$("#p1_cat, #p1_area, #p1_team, #p1_group, #p1_title, #p1_content, #p1_fsFlag, #p1_fsValue, #p1_fsFormula");var Q={qobj:$("#p1_uploader"),obj:P,cat:"JOB",uploadable:true,qatts:$("#p1_atts"),atts:O["job.atts"],params:R};if(S==j){$("#p1_title").itip("请输入题目");$("#p1_content").itip("请输入详细内容");$("#p1_fsValue").itip("请输入财务成果结果");$("#p1_fsFormula").itip("请输入财务成果计算公式");i.each(function(){$(this).attr("_value",$(this).val());if(this.tagName=="SELECT"){$(this).removeAttr("disabled")}else{$(this).removeAttr("readonly")}});P["#checkItems"]=i;G(Q)}else{P["#check"]=false;$("#p1_title").itip("");$("#p1_content").itip("");$("#p1_fsValue").itip("");$("#p1_fsFormula").itip("");i.each(function(){if(this.tagName=="SELECT"){$(this).attr("disabled",true)}else{$(this).attr("readonly","readonly")}});Q.uploadable=false;G(Q)}}function B(Q){var N=$("#p1_team");var S=N.get(0);var P=N.children().eq(S.selectedIndex);var R=P.data();if(!R){return}var i=R.groups;var O=$("#p1_group");O.children().remove();O.addOptions(i,{value:"code",text:"name"})}function u(i,P,O,N){var R;if(P==j){R=[{text:"审批",click:h},{text:"拒批",click:C},{text:"返回",click:L}]}else{R=[{text:"审批"},{text:"拒批"},{text:"返回",click:L}]}n(R,i,N);var U=O["job.requester"];var V=O["job.dept1"];var Q=new Date(i.reqTime);var T=O["job.cat"];$("#p2_reqTime").text(Q.format(IDS_FORMAT_DATE));$("#p2_reqTime").attr("title",Q.format(IDS_FORMAT_DATE));$("#p2_dept0").text(U.dept);$("#p2_dept0").attr("title",U.dept);$("#p2_requesterName").text(U.name);$("#p2_requesterName").attr("title",U.name);$("#p2_requester").text(i.requester);$("#p2_requester").attr("title",i.requester);$("#p2_cat").text(T.text);$("#p2_cat").attr("title",T.text);$("#p2_dept1").text(V.name);$("#p2_dept1").attr("title",V.name);$("#p2_requesterSin").text(U.mysin);$("#p2_requesterSin").attr("title",U.mysin);$("#p2_requesterDuty").text(U.duty);$("#p2_requesterDuty").attr("title",U.duty);$("#p2_requesterTel").text(U.tel);$("#p2_requesterTel").attr("title",U.tel);$("#p2_fsValue").text(i.fsValue);$("#p2_fsValue").attr("title",i.fsValue);$("#p2_title").text("题目: "+i.title);$("#p2_content").text("详细内容: "+i.content);$("#p2_fsFormula").text("财务成果计算公式: "+(i.fsFormula?i.fsFormula:""));var S={qobj:$("#p2_uploader"),obj:i,cat:"JOB",uploadable:false,qatts:$("#p2_atts"),atts:O["job.atts"],params:N};G(S);$("#p2_org").children().remove();$("#p2_team").children().remove();$("#p2_area").addOptions(O["job.areas"],{value:"code",text:"text"});$("#p2_team").addOptions(O["job.teams"],{value:"code",text:"name"});$("#p2_team").bind("change",B);B();if(i.area){$("#p2_area").val(i.area)}}function t(O,Q,N,P){var i;if(Q==j){i=[{text:"审批",click:p},{text:"拒批",click:d},{text:"返回",click:L}]}else{i=[{text:"审批"},{text:"拒批"},{text:"返回",click:L}]}n(i,O,P)}function s(P,R,O,Q){var i=P.act;var N;if(R==j){if(i.approver1){N=[{text:"修改",click:m},{text:"返回",click:D}]}else{N=[{text:"提交",click:addAct},{text:"修改",click:m},{text:"返回",click:D}]}}else{N=[{text:"修改"},{text:"返回",click:D}]}n(N,P,Q)}function r(P,R,O,Q){var i=P.act;var N;if(R==j){N=[{text:"审批",click:a},{text:"拒批",click:w},{text:"返回",click:D}]}else{N=[{text:"审批"},{text:"拒批"},{text:"返回",click:D}]}n(N,P,Q)}function o(O,P,i,N){if(typeof(O[N])=="function"){O[N](O,P,i)}else{if(typeof(P[N])=="function"){P[N](O,P,i)}}}function l(){A(0);$("#job_upload").hide();$("#job_buttons").hide()}this.closeAll=l;function L(Q,R,i){var O=function(){l();o(Q,R,i,"#onJobReturn")};var N=function(){};var P=function(S){if(S==ID_YES){O()}else{if(S==ID_NO){N()}}};if(Q["#changed"]()){MessageBox("您的提案还没有保存, 您确定离开吗?",IDS_TITLE,MB_ICONQUESTION,MB_YESNO,P,0)}else{O()}}function e(N){var i="",O;if(N.title.empty()){i="提案主题为空!";O=$("#p1_title")}else{if(N.content.empty()){i="提案内容为空!";O=$("#p1_content")}}if(i){MessageBox(i,null,MB_ICONERROR,MB_OK,function(){O.focus()});return false}return true}function K(R,S,O){var Q=function(T){o(R,S,O,"#onJobAdd")};var i=function(T){R["#checkItems"].each(function(){$(this).attr("_value",$(this).val())});MessageBox(T.message,null,MB_ICONINFORMATION,MB_OK,Q,0)};var P={id:R.id,cat:$("#p1_cat").val(),area:$("#p1_area").val(),dept1:$("#p1_group").val(),title:$("#p1_title").val(),content:$("#p1_content").val(),fsFlag:$("#p1_fsFlag").val(),fsValue:$("#p1_fsValue").val(),fsFormula:$("#p1_fsFormula").val(),extra:{me:IDS_ACC.pernr}};if(!e(P)){return}var N=$.toJSON(P);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/job/process",data:N,dataType:"json",success:i,error:function(){ajaxError(arguments,this)}})}function z(R,S,O){var Q=function(T){o(R,S,O,"#onJobSave")};var i=function(T){if(!T.error){R["#checkItems"].each(function(){$(this).attr("_value",$(this).val())});$.extend(R,P);MessageBox(T.message,null,MB_ICONINFORMATION,MB_OK,Q,0)}else{MessageBox(T.message,null,MB_ICONERROR,MB_OK,null,0)}};var P={id:R.id,cat:$("#p1_cat").val(),area:$("#p1_area").val(),dept1:$("#p1_group").val(),title:$("#p1_title").val(),content:$("#p1_content").val(),fsFlag:$("#p1_fsFlag").val(),fsValue:$("#p1_fsValue").val(),fsFormula:$("#p1_fsFormula").val(),extra:{me:IDS_ACC.pernr}};if(!e(P)){return}var N=$.toJSON(P);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/job/process",data:N,dataType:"json",success:i,error:function(){ajaxError(arguments,this)}})}function E(R,S,Q){var N=function(T){o(R,S,Q,"#onJobDelete")};var i=function(T){if(!T.error){R["#checkItems"].each(function(){$(this).attr("_value",$(this).val())});MessageBox(T.message,null,MB_ICONINFORMATION,MB_OK,N,0)}else{MessageBox(T.message,null,MB_ICONERROR,MB_OK,null,0)}};var P=function(V){var U={id:V.id,extra:{me:IDS_ACC.pernr}};var T=$.toJSON(U);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/job/delete",data:T,dataType:"json",success:i,error:function(){ajaxError(arguments,this)}})};var O=function(T){if(T==ID_YES){P(R)}};MessageBox("确实要删除提案["+R.title+"]吗?",null,MB_ICONQUESTION,MB_YESNO,O,0)}function h(N,O,i){}function C(N,O,i){}function p(N,O,i){}function d(N,O,i){}function m(N,O,i){}function D(R,S,N){var i=R.act;var P=function(){l();o(R,S,N,"#onActReturn")};var O=function(){};var Q=function(T){if(T==ID_YES){P()}else{if(T==ID_NO){O()}}};if(R["#changed"]()){MessageBox("您的改善还没有保存, 您确定离开吗?",IDS_TITLE,MB_ICONQUESTION,MB_YESNO,Q,0)}else{P()}}function a(N,O,i){}function w(N,O,i){}};$(function(){IDS_JOB=new IdsJob()});