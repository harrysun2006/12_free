var bt_login={fill:"#F7F7F7",cssStyles:{color:"#000000"},trigger:["focus"],shrinkToFit:true,padding:5,cornerRadius:2,spikeLength:10,spikeGirth:6,strokeStyle:"#B7B7B7"};var bt_vcode={contentSelector:"$('#dvcode').html()",fill:"#F7F7F7",cssStyles:{color:"#000000"},shrinkToFit:true,padding:"5px 5px 0px 5px",cornerRadius:2,spikeLength:10,spikeGirth:6,strokeStyle:"#B7B7B7",postShow:function(a){$("#avcode",a).click(function(){refreshVcode(a)});refreshVcode(a)}};var BIND_KEYDOWN_ITEMS;function refreshVcode(b){var a=new Date().getTime();var c=IDS_CONTEXT_PATH+"/vcode?"+a;$("#ivcode",b).attr("src",c)}function validLoginData(c){var a=false;var d="";var b=null;if(c.pernr.empty()){d="请输入非空工号!";b=function(e){$("#pernr").trigger("focus")}}else{if(LOGIN_USE_VCODE&&!c.extra.vcode.match(/^[2-8]{4}$/)){d="请输入合法验证码!";b=function(e){$("#vcode").trigger("focus");$("#vcode").trigger("select")}}else{a=true}}if(!a&&d){MessageBox(d,IDS_WARNING,MB_ICONWARNING,null,b,2)}return a}function initLoginUI(){$("#logout_box").hide();$("#login_box").show();bind(BIND_KEYDOWN_ITEMS);$("#pernr").val("");$("#password").val("");$("#vcode").val("");$("#pernr").trigger("focus");if(LOGIN_USE_VCODE){$("#svcode").css("visibility","visible")}else{$("#svcode").css("visibility","hidden")}}function processLogin(a){var b=a.error;var c="";if(!b){IDS_ACC=a.IDS_ACC;initLogoutUI();return}else{if(b=="account.unknown"){c="系统未找到对应工号!"}else{if(b=="account.disabled"){c="此工号的账号已被禁用!"}else{if(b=="password"){c="密码错误!"}else{if(b=="vcode"){c="验证码错误!"}else{if(b=="error"){c="其他验证错误!"}else{c="未知错误!"}}}}}}MessageBox(c,IDS_ERROR,MB_ICONERROR,MB_OK,null,0)}function initLogoutUI(){$("#login_box").hide();$("#logout_box").show();unbind(BIND_KEYDOWN_ITEMS);if(IDS_ACC){$("#t_pernr").text(IDS_ACC.pernr);$("#t_pernr").attr("title",IDS_ACC.pernr);$("#t_name").text(IDS_ACC.emp.name);$("#t_name").attr("title",IDS_ACC.emp.name);$("#t_duty").text(IDS_ACC.emp.duty);$("#t_duty").attr("title",IDS_ACC.emp.duty)}if(IDS_ACC.admin){if(IDS_ACC.extra.admin_type==1){disableResetPass()}else{enableResetPass()}}else{enableResetPass()}}function enableResetPass(){$("#reset_pass").removeClass("disabled");$("#reset_pass").addClass("enabled");$("reset_pass").data.enabled=true}function disableResetPass(){$("#reset_pass").removeClass("enabled");$("#reset_pass").addClass("disabled");$("reset_pass").data.enabled=false}function processLogout(a){if(!a.error){IDS_ACC=false;initLoginUI()}}function validResetData(c){var a=false;var d="";var b=function(e){$("#p1").trigger("focus");$("#p1").trigger("select")};if(c.extra.p1!=c.extra.p2){d="请确定2次输入的密码一致!"}else{if(c.extra.p1.length<6){d="请输入6位以上的密码!"}else{a=true}}if(!a&&d){MessageBox(d,IDS_WARNING,MB_ICONWARNING,null,b,2)}return a}function processReset(a){var b=a.error;var f="";var e=IDS_ERROR;var c=MB_ICONERROR;var g=null;var d=0;if(!b){f="已成功修改账号["+a.pernr+"]的密码!";e=IDS_INFO;c=MB_ICONINFORMATION;g=function(h){$.fancybox.close()};d=2}else{if(b=="account.unknown"){f="系统未找到对应工号!"}else{if(b=="account.disabled"){f="此工号的账号已被禁用!"}else{if(b=="password.tooshort"){f="密码太短!"}else{if(b=="password.mismatch"){f="2次输入的密码不一致!"}else{f="未知错误!"}}}}}MessageBox(f,e,c,MB_OK,g,d)}function initBT(){try{$("#pernr").focus();$("#pernr").bt(bt_login);$("#vcode").bt(bt_vcode)}catch(a){}}$(function(){initMenu(0);$("#reset_pass").data={enabled:true};BIND_KEYDOWN_ITEMS={keydown:genericKeyDown};if(LOGIN_USE_VCODE){BIND_KEYDOWN_ITEMS.controls=[$("#pernr"),$("#password"),$("#vcode"),$("#login")]}else{BIND_KEYDOWN_ITEMS.controls=[$("#pernr"),$("#password"),$("#login")]}initBT();if(IDS_ACC){initLogoutUI()}else{initLoginUI()}$("#login").click(function(){var b={pernr:$("#pernr").val(),password:$("#password").val(),extra:{vcode:$("#vcode").val(),rememberMe:true}};if(!validLoginData(b)){return}var a=$.toJSON(b);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/account/login",data:a,dataType:"json",success:function(c){processLogin(c)},error:function(){ajaxError(arguments,this)}})});$("#logout").click(function(){var b={};var a=$.toJSON(b);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/account/logout",success:function(c){processLogout(c)},error:function(){ajaxError(arguments,this)}})});$("#reset_pass").fancybox({autoScale:true,transitionIn:"none",transitionOut:"none",overlayShow:false,onStart:function(){return $("#reset_pass").data.enabled}});$("#reset_yes").click(function(){var b={pernr:IDS_ACC.pernr,extra:{p1:$("#p1").val().trim(),p2:$("#p2").val().trim()}};if(!validResetData(b)){return}var a=$.toJSON(b);$.ajax({type:"POST",contentType:"application/json",url:IDS_CONTEXT_PATH+"/account/reset_pass",data:a,dataType:"json",success:function(c){processReset(c)},error:function(){ajaxError(arguments,this)}})});$("#reset_no").click(function(){$.fancybox.close()})});