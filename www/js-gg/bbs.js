(function(e){function v(a,b,d){var c=e(document.createElement("li")),f=e(document.createElement("a"));f.text(d.name);f.attr("href","#ff_"+d.id);f.attr("title",d.description);c.append(f);b.append(c);var b=e(document.createElement("div")),c=e(document.createElement("div")),f=e(document.createElement("span")),j=e(document.createElement("div")),k=e(document.createElement("div")),h=e(document.createElement("table")),g=e(document.createElement("div"));b.attr("id","ff_"+d.id);c.attr("id","f1_"+d.id);f.attr("id",
"fa_"+d.id);f.text(d.description);f.css("float","left");j.attr("id","fb_"+d.id);h.attr("id","ft_"+d.id);g.attr("id","fp_"+d.id);g.attr("title",d.name);b.addClass("bbs");c.addClass("a");k.addClass("b");b.append(c);b.append(k);c.append(f);c.append(j);k.append(h);k.append(g);a.append(b);c.width(b.width()-10);k.width(b.width()-15);f.height(c.height());f.css("line-height",c.height()+"px");a.add("#ff_"+d.id,d.name,d.idx)}function m(a){e.ajax({type:"POST",contentType:"application/json",data:e.toJSON(a),
dataType:"json",url:IDS_CONTEXT_PATH+"/topic/list",success:function(b){b.error?MessageBox(getErrorMessage(b.error),IDS_ERROR,MB_ICONERROR,MB_OK,null,0):o(a,b.topics)},error:function(){ajaxError(arguments,this)}})}function o(a,b){e("#bbs_forum").show();e("#bbs_topic").hide();var d=e("#ft_"+a.id),c=e("#fp_"+a.id),f={};d.clearGridData(true);d.jqGrid({autowidth:true,datatype:"local",height:"auto",colNames:["ID","\u4e3b\u9898","\u4f5c\u8005","\u56de\u590d/\u67e5\u770b","\u6700\u540e\u53d1\u8868"],colModel:[{name:"id",
hidden:true},{name:"title",fixed:false,sortable:false,formatter:function(a,b,c){var d=a;b.colModel.name=="title"&&(b=e(document.createElement("div")),c.top&&b.addElement({id:h+g++,type:"span",css:"bbs_top,left"}),c.up>0&&b.addElement({id:h+g++,type:"span",css:"bbs_up,left"}),b.addElement({id:h+g++,type:"span",text:a,css:"left"}),d=b.html());return d},align:"left"},{name:"#creator",width:120,fixed:true,sortable:false,align:"center"},{name:"#count",width:80,fixed:true,sortable:false,align:"center"},
{name:"#last",width:120,fixed:true,sortable:false,align:"center"}],loadui:true,multiselect:false,ondblClickRow:function(){var b=e("#ft_"+a.id).selectedItems(),b=b&&b.length>0?b[0]:null;b==null?MessageBox("\u8bf7\u9009\u62e9\u4e00\u4e2a\u4e3b\u9898!",IDS_ERROR,MB_ICONERROR,MB_OK,null,3):p(b)},onSelectRow:function(){var b=e("#ft_"+a.id).selectedItems();q(a,b&&b.length>0?b[0]:null)},scroll:false,scrollOffset:0,altclass:"jqgrow-odd",altRows:true,rowNum:10,rowList:[10,20,30],pager:c,recordpos:"left",pagerpos:"center",
viewrecords:true});q(a);b==null&&(b=[]);for(i=0;i<b.length;i++)c=b[i],f[c.id]=c,c.forum=a,c["#creator"]=c.creator.name+"\n"+(new Date(c.dateline)).format("Y-m-d"),c["#count"]=c.cntReply+"/"+c.cntView,c["#last"]=(c.lastPostCreator?c.lastPostCreator.name:"")+"\n"+(c.lastPostDateline?(new Date(c.lastPostDateline)).format("Y-m-d"):"");d.setGridParam({data:b,map:f,page:1});d.trigger("reloadGrid");d.setSelection(0)}function q(a,b){var d=IDS_ACC,c=[];(a.cat=="N"||a.cat=="T"&&(d.admin||d.emp.manager))&&c.push({text:"\u53d1\u5e16",
title:"\u53d1\u8868\u65b0\u8bdd\u9898",click:w});b&&d.admin&&(c.push({text:"\u5220\u9664",title:"\u5220\u9664",command:"delete",click:l}),b.up<=0?c.push({text:"\u52a0\u661f",title:"\u52a0\u661f",command:"up",click:l}):c.push({text:"\u53d6\u6d88\u52a0\u661f",title:"\u53d6\u6d88\u52a0\u661f",command:"down",click:l}),b.top?c.push({text:"\u53d6\u6d88\u7f6e\u9876",title:"\u53d6\u6d88\u7f6e\u9876",command:"bottom",click:l}):c.push({text:"\u7f6e\u9876",title:"\u7f6e\u9876",command:"top",click:l}));d={clear:true,
data:[b?b:{forum:a}]};e("#fb_"+a.id).addButtons(c,d)}function p(a){e.ajax({type:"POST",contentType:"application/json",data:e.toJSON(a),dataType:"json",url:IDS_CONTEXT_PATH+"/post/list",success:function(a){a.error?MessageBox(getErrorMessage(a.error),IDS_ERROR,MB_ICONERROR,MB_OK,null,0):r(a.topic,a.posts)},error:function(){ajaxError(arguments,this)}})}function w(a,b){e.IDS_INFO.open({forum:a.forum,topic:a,title:"",content:"",op:"add",caption:b.title,"#onSave":s})}function s(a){var b={title:a["#title"],
content:a["#content"],forum:a.forum};if(a.hasOwnProperty("id"))b.id=a.id;n(b,a.op,a["#onSaved"])}function l(a,b){var d=e("#ft_"+a.forum.id).selectedItems();n(d&&d.length>0?d[0]:null,b.command)}function n(a,b,d){if(a==null)MessageBox("\u8bf7\u9009\u62e9\u4e00\u4e2a\u4e3b\u9898!",IDS_ERROR,MB_ICONERROR,MB_OK,null,3);else{var c=function(a){a.error&&MessageBox(getErrorMessage(a.error),IDS_ERROR,MB_ICONERROR,MB_OK,null,0);o(a.forum,a.topics)};e.ajax({type:"POST",contentType:"application/json",data:e.toJSON({command:b,
topic:a}),dataType:"json",url:IDS_CONTEXT_PATH+"/topic/process",success:d?d:c,error:function(){ajaxError(arguments,this)}})}}function r(a,b){e("#bbs_forum").hide();e("#bbs_topic").show();var d=e("#tt_data"),c=e("#tt_pager"),f=function(b,c,d){return x(a,b,c,d)};d.clearGridData(true);d.jqGrid({autowidth:true,datatype:"local",height:"auto",colNames:["ID","\u4f5c\u8005","\u5185\u5bb9"],colModel:[{name:"id",hidden:true},{name:"#col1",formatter:f,fixed:true,title:false,align:"center",width:160},{name:"#col2",
formatter:f,fixed:false,title:false,align:"left"}],loadui:true,multiselect:false,scroll:false,scrollOffset:0,rowNum:10,rowList:[10,20,30],pager:c,recordpos:"left",pagerpos:"right",viewrecords:false,hoverrows:false,gridview:true});b==null&&(b=[]);c=cloneObject(a);f=cloneObject(a);c["#type"]="TT";f["#type"]="TC";b.unshift(c,f);for(i=0;i<b.length;i++)c=b[i],c["#type"]||(c["#type"]="PP"),c.forum=a.forum;d.setGridParam({data:b,page:1});d.trigger("reloadGrid")}function y(a){a=a.data[0];e("#bbs_topic").hide();
e("#bbs_forum").show();a&&a.forum&&m(a.forum)}function x(a,b,d,c){var b=c["#type"],f=d.colModel.name,j=c.creator?c.creator:{},k=j?j.profile:{},l=function(a,b){e("#"+b).parent().parent().attr("valign","top")},d=e(document.createElement("div")),a=e(document.createElement("div"));a.attr("id",h+g++);a.css("width","99%");if(b=="TT")f=="#col1"?(c="\u67e5\u770b: "+c.cntView+"\u56de\u590d: "+c.cntReply,a.addElement({type:"span",text:c})):f=="#col2"&&(a.addClass("left"),a.addClass("m6"),a.addElement({id:h+
g++,type:"span",text:c.title,css:"h3,left"}),c.top&&a.addElement({id:h+g++,type:"span",css:"bbs_top,left"}),c.up>0&&a.addElement({id:h+g++,type:"span",css:"bbs_up,left"}),a.addElement({id:h+g++,type:"a",text:"\u8fd4\u56de",css:"right,button,enabled",click:y,params:[c]}),a.addElement({id:h+g++,type:"a",text:"\u56de\u590d",css:"right,button,enabled",click:z,params:[c]}));else if(b=="TC"||b=="PP")a.addClass("left"),a.addClass("m0"),f=="#col1"?(c="\u5de5\u53f7: "+j.pernr+"<BR>\u59d3\u540d: "+j.name+"<BR>\u53d1\u5e16\u6570: "+
k.cntTopic+"<BR>\u8ddf\u5e16\u6570: "+k.cntPost+"<BR>\u79ef\u5206: "+k.karma,a.addElement({id:h+g++,type:"span",html:c,css:"bcol1",onShow:l})):f=="#col2"&&(b=a.addElement({id:h+g++,type:"span",css:"bcol2"}),b.addElement({id:h+g++,type:"span",css:"bbs_member,left"}),b.addElement({id:h+g++,type:"span",text:" \u53d1\u8868\u4e8e "+(new Date(c.dateline)).format("Y-m-d H:i:s")}),j.pernr==IDS_ACC.pernr&&b.addElement({id:h+g++,type:"span",css:"bbs_delete,right,button,enabled",title:"\u5220\u9664",click:A,
params:[c]}),j.pernr==IDS_ACC.pernr&&b.addElement({id:h+g++,type:"span",css:"bbs_edit,right,button,enabled",title:"\u7f16\u8f91",click:B,params:[c]}),a.addElement({id:h+g++,type:"div",css:"clear"}),a.addElement({id:h+g++,type:"span",css:"left",html:c.content}));d.append(a);return d.html()}function z(a){a=a.data[0];e.IDS_INFO.open({topic:a,content:"",op:"add",caption:"\u56de\u590d:"+a.title,"#onSave":t})}function A(a){var a=a.data[0],b=a["#type"];b=="TC"?n(a,"delete"):b=="PP"&&u(a,"delete")}function B(a){var b=
a.data[0],a=b["#type"];a=="TC"?(a={id:b.id,forum:b.forum,topic:b.topic,title:b.title,content:b.content,op:"update",caption:"\u7f16\u8f91\u4e3b\u9898: "+b.title,"#onSave":s,"#onSaved":function(){p(b.id)}},e.IDS_INFO.open(a)):a=="PP"&&(a={id:b.id,forum:b.forum,topic:b.topic,content:b.content,op:"update",caption:"\u7f16\u8f91\u5e16\u5b50: "+b.title,"#onSave":t},e.IDS_INFO.open(a))}function t(a){var b={content:a["#content"],topic:a.topic};if(a.hasOwnProperty("id"))b.id=a.id;u(b,a.op,a["#onSaved"])}function u(a,
b){a==null?MessageBox("\u8bf7\u8f93\u5165\u56de\u590d\u5185\u5bb9!",IDS_ERROR,MB_ICONERROR,MB_OK,null,3):(a.topic={id:a.topic.id},e.ajax({type:"POST",contentType:"application/json",data:e.toJSON({command:b,post:a}),dataType:"json",url:IDS_CONTEXT_PATH+"/post/process",success:function(a){a.error?MessageBox(getErrorMessage(a.error),IDS_ERROR,MB_ICONERROR,MB_OK,null,0):r(a.topic,a.posts)},error:function(){ajaxError(arguments,this)}}))}var h="tt_auto_",g=1E4;e.BBS=e.BBS||{version:"1.0.0",name:"BBS"};
e.extend(e.BBS,{init:function(a){e("bbs_topic").hide();var b=e("#bbs_forum"),d=a.forums,a=e(document.createElement("ul")),c;b.append(a);for(c=0;c<d.length;c++)v(b,a,d[c]);b.tabs({selected:0,select:function(a,b){m(d[b.index])}});d.length>0&&m(d[0])}})})(jQuery);$(function(){$.IDS_MENU.init(4);$.ajax({type:"POST",contentType:"application/json",data:$.toJSON({}),dataType:"json",url:IDS_CONTEXT_PATH+"/forum/list",success:$.BBS.init,error:function(){ajaxError(arguments,this)}})});
